# 三维空间绕任意直线旋转变换

## 要求

试推导三维空间中某点 P 以点 A(0, 0, 1) 和点 B(1, 1, 2) 所在直线为旋转轴，逆时针旋转 θ 角的各个变换矩阵及复合变换矩阵表达式，并以 P=(1, 1, 1)、θ=30° 为例尝试编程计算旋转后的新坐标。

## 理论推导

### 问题分析

要将点 P 绕任意直线 AB 旋转 θ 角，需要通过一系列变换将问题简化：

1. **平移变换**：将直线平移使其经过原点
2. **第一次旋转**：将直线旋转到 xOz 平面
3. **第二次旋转**：将直线旋转到与 z 轴重合
4. **绕 z 轴旋转**：旋转 θ 角
5. **逆变换**：执行上述变换的逆过程

### 具体推导过程

#### 平移变换矩阵 T

将点 A(0, 0, 1) 平移到原点：

```
T = | 1  0  0  -0 |   | 1  0  0   0 |
    | 0  1  0  -0 | = | 0  1  0   0 |
    | 0  0  1  -1 |   | 0  0  1  -1 |
    | 0  0  0   1 |   | 0  0  0   1 |
```

#### 第一次旋转矩阵 R₁（绕 z 轴）

将直线旋转到 xOz 平面。设直线方向向量为 $\vec{AB} = (1, 1, 1)$。

在 xOy 平面上的投影与 x 轴的夹角：
$$r_1 = \arctan\left(\frac{y_1 - y_0}{x_1 - x_0}\right) = \arctan\left(\frac{1}{1}\right) = \frac{\pi}{4}$$

绕 z 轴旋转 $-r_1$ 角：

```
R₁ = | cos(-r₁)  -sin(-r₁)  0  0 |   | cos(r₁)   sin(r₁)   0  0 |
     | sin(-r₁)   cos(-r₁)  0  0 | = |-sin(r₁)   cos(r₁)   0  0 |
     |    0          0      1  0 |   |    0         0      1  0 |
     |    0          0      0  1 |   |    0         0      0  1 |
```

#### 第二次旋转矩阵 R₂（绕 y 轴）

将直线旋转到与 z 轴重合。

直线与 z 轴的夹角：
$$r_2 = \arctan\left(\frac{\sqrt{(x_1-x_0)^2 + (y_1-y_0)^2}}{z_1-z_0}\right) = \arctan\left(\frac{\sqrt{2}}{1}\right)$$

绕 y 轴旋转 $r_2$ 角：

```
R₂ = | cos(r₂)   0  -sin(r₂)  0 |
     |    0      1      0     0 |
     | sin(r₂)   0   cos(r₂)  0 |
     |    0      0      0     1 |
```

#### 预变换矩阵

组合前三个变换：
$$M_{pre} = R_2 \cdot R_1 \cdot T$$

#### 绕 z 轴旋转矩阵 Rz (θ)

逆时针旋转 θ 角：

```
Rz(θ) = | cos(θ)  -sin(θ)  0  0 |
        | sin(θ)   cos(θ)  0  0 |
        |   0        0     1  0 |
        |   0        0     0  1 |
```

#### 后变换矩阵

预变换的逆矩阵：
$$M_{post} = M_{pre}^{-1}$$

#### 复合变换矩阵

最终的复合变换矩阵为：
$$M = M_{post} \cdot R_z(\theta) \cdot M_{pre}$$

即：
$$M = M_{pre}^{-1} \cdot R_z(\theta) \cdot M_{pre}$$

### 数值计算示例

对于给定参数：
- 点 A(0, 0, 1)
- 点 B(1, 1, 2)
- 点 P(1, 1, 1)
- θ = 30° = π/6 弧度

代入上述矩阵表达式计算可得旋转后的新坐标（详见下方运行结果）。

## 程序实现

### 环境要求

- Go 1.25.3
- gonum 矩阵运算库

### 安装依赖

```bash
go mod tidy
```

### 代码结构

```
3d-transformation-demo/
├── main.go              # 主程序入口
├── utils/
│   ├── transform.go     # 变换矩阵实现
│   └── input.go         # 输入处理工具
├── go.mod
└── README.md
```

### 核心函数说明

#### `TranslationMatrix(dx, dy, dz float64) *mat.Dense`
生成 4×4 平移矩阵。

#### `RotateAroundX/Y/Z(theta float64) *mat.Dense`
生成绕 x/y/z 轴旋转的 4×4 旋转矩阵，参数 theta 为弧度。

#### `RotateOverALine(lineStart, lineEnd, point mat.Vector, theta float64) (mat.Vector, error)`
实现绕任意直线旋转点的完整算法：
1. 平移直线到原点
2. 旋转到 xOz 平面
3. 旋转到 z 轴
4. 绕 z 轴旋转 θ
5. 执行逆变换

### 编译运行

```bash
# 编译
go build -o build/3d_transform

# 运行
./build/3d_transform
```

或直接运行：

```bash
go run main.go
```

### 使用说明

程序会依次提示输入：
1. 要旋转的点坐标（x y z）
2. 旋转角度（度）
3. 直线起点坐标（x y z）
4. 直线终点坐标（x y z）

程序将输出：
- 各个变换矩阵（平移、旋转到 xOz、旋转到 z 轴等）
- 预旋转矩阵及其逆矩阵
- 组合变换矩阵
- 原始点坐标
- 旋转后点坐标

## 运行结果

以 P=(1, 1, 1)、θ=30°、A(0, 0, 1)、B(1, 1, 2) 为例的运行结果：

```
请输入要旋转的点坐标（x y z）：
1 1  1
请输入旋转角度（度）：
30  
请输入直线起点坐标（x y z）：
0 0 1
请输入直线终点坐标（x y z）：
1 1 2
平移矩阵：
⎡ 1   0   0  -0⎤
⎢ 0   1   0  -0⎥
⎢ 0   0   1  -1⎥
⎣ 0   0   0   1⎦

旋转到 XoZ 平面 矩阵：
⎡ 0.7071067811865476   0.7071067811865475                    0                    0⎤
⎢-0.7071067811865475   0.7071067811865476                    0                    0⎥
⎢                  0                    0                    1                    0⎥
⎣                  0                    0                    0                    1⎦

旋转到 Z 轴 矩阵：
⎡0.5773502691896258                   0  -0.816496580927726                   0⎤
⎢                 0                   1                   0                   0⎥
⎢ 0.816496580927726                   0  0.5773502691896258                   0⎥
⎣                 0                   0                   0                   1⎦

预旋转矩阵：
⎡ 0.4082482904638631    0.408248290463863   -0.816496580927726    0.816496580927726⎤
⎢-0.7071067811865475   0.7071067811865476                    0                    0⎥
⎢ 0.5773502691896258   0.5773502691896257   0.5773502691896258  -0.5773502691896258⎥
⎣                  0                    0                    0                    1⎦

预旋转矩阵的逆：
⎡0.4082482904638631   -0.7071067811865475   0.5773502691896257  -4.4052922453275756e-18⎤
⎢0.40824829046386296  0.7071067811865476    0.5773502691896257                       -0⎥
⎢-0.8164965809277259  -6.05302684324031e-17 0.5773502691896256                        1⎥
⎣0                    0                     0                                         1⎦

绕 Z 轴旋转 矩阵：
⎡  0.8660254037844387  -0.49999999999999994                     0                     0⎤
⎢ 0.49999999999999994    0.8660254037844387                     0                     0⎥
⎢                   0                     0                     1                     0⎥
⎣                   0                     0                     0                     1⎦

组合变换矩阵：
⎡  0.9106836025229591  -0.24401693585629244   0.33333333333333326  -0.33333333333333326⎤
⎢  0.3333333333333333    0.9106836025229592  -0.24401693585629236   0.24401693585629236⎥
⎢-0.24401693585629244   0.33333333333333315     0.910683602522959   0.08931639747704101⎥
⎣                   0                     0                     0                     1⎦

原始点：
⎡1⎤
⎢1⎥
⎣1⎦

旋转后点：
⎡0.6666666666666666⎤
⎢1.2440169358562922⎥
⎣1.0893163974770408⎦

```

## 参考资料

- 计算机图形学教材相关章节
- 三维变换与齐次坐标系统
- gonum 矩阵运算库文档
